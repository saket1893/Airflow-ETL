# syntax=docker/dockerfile:1

# Start from a lightweight Python base image
FROM python:3.11-slim

# Set environment variables to reduce prompts and set Airflow home
ENV AIRFLOW_HOME=/opt/airflow \
    AIRFLOW_VERSION=2.9.1 \
    PYTHON_VERSION=3.11 \
    AIRFLOW__CORE__EXECUTOR=SequentialExecutor \
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:///airflow.db \
    PIP_NO_CACHE_DIR=true

# Create airflow user and working directory
RUN adduser --disabled-password --gecos '' airflow && \
    mkdir -p $AIRFLOW_HOME && \
    chown -R airflow:airflow $AIRFLOW_HOME

WORKDIR $AIRFLOW_HOME

# Install OS dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    git \
    curl \
    netcat \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Apache Airflow using constraints for stability
RUN pip install "apache-airflow==${AIRFLOW_VERSION}" \
    --constraint "https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"

# Switch to airflow user
USER airflow

# Expose port for the webserver
EXPOSE 8080

# Entrypoint
CMD ["airflow", "standalone"]
